name: Auto Move Project Card
on:
  issues:
    types: [labeled, assigned]

permissions:
  contents: read
  issues: write # สิทธิ์สำหรับการจัดการ Issue
  pull-requests: write # อาจจะจำเป็นในการดึง Project ID 

env:
  # Project ID ที่ถูกต้องสำหรับ Project V2 'DevOps-Issue'
  PROJECT_ID: PVT_kwHOAhgQ884BGnV2 
  
jobs:
  # -----------------------------------------------
  # 1. TODO: เมื่อ Issue ถูกติด Label 'Todo'
  # -----------------------------------------------
  move_to_todo:
    # Trigger เมื่อติด Label ที่ชื่อ 'Todo'
    if: github.event.action == 'labeled' && github.event.label.name == 'Todo'
    runs-on: ubuntu-latest
    
    steps:
      - name: Set Status to Todo via GraphQL
        uses: actions/github-script@v6
        with:
          # ใช้ Personal Access Token (PAT) ที่มีสิทธิ์ 'project' และ 'repo'
          github-token: ${{ secrets.PROJECT_PAT }} 
          script: |
            const core = require('@actions/core');
            const PROJECT_ID = process.env.PROJECT_ID;
            const CONTENT_ID = context.payload.issue.node_id;

            // 1. ค้นหา Field ID และ Option ID ของ Status:Todo
            const projectRes = await github.graphql(`
              query getProjectFields($id: ID!) {
                node(id: $id) {
                  ... on ProjectV2 {
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2SingleSelectField { id name options { id name } }
                      }
                    }
                  }
                }
              }`, { id: PROJECT_ID });
            
            const statusField = projectRes.node.fields.nodes.find(f => f.name === 'Status');
            
            // **การตรวจสอบข้อผิดพลาด 1: Field Name**
            if (!statusField) {
              core.setFailed("Error: 'Status' field not found. Check Field Name and case sensitivity in Project Settings.");
              return; 
            }
            
            const statusFieldId = statusField.id;
            const todoOption = statusField.options.find(o => o.name === 'Todo');
            
            // **การตรวจสอบข้อผิดพลาด 2: Option Name**
            if (!todoOption) {
              core.setFailed("Error: 'Todo' option not found in Status field. Check Option Name and case sensitivity in Project Settings.");
              return;
            }
            const todoOptionId = todoOption.id;

            // 2. ทำการ Mutation เพื่อ Update Status
            await github.graphql(`
              mutation updateProjectStatus($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId,
                  itemId: $itemId,
                  fieldId: $fieldId,
                  value: { singleSelectOptionId: $optionId }
                }) {
                  projectV2Item { id }
                }
              }`, {
              projectId: PROJECT_ID,
              itemId: CONTENT_ID,
              fieldId: statusFieldId,
              optionId: todoOptionId,
            });
            
            core.info(`Successfully moved item ${CONTENT_ID} to Status: Todo`);

  # -----------------------------------------------
  # 2. IN PROGRESS: เมื่อ Assign Engineer
  # -----------------------------------------------
  move_to_in_progress:
    # Trigger เมื่อมีการ Assign
    if: github.event.action == 'assigned'
    runs-on: ubuntu-latest
    
    steps:
      - name: Set Status to In Progress via GraphQL
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PROJECT_PAT }} 
          script: |
            const core = require('@actions/core');
            const PROJECT_ID = process.env.PROJECT_ID;
            const CONTENT_ID = context.payload.issue.node_id;
            
            // 1. ค้นหา Field ID และ Option ID ของ Status:In Progress
            const projectRes = await github.graphql(`
              query getProjectFields($id: ID!) {
                node(id: $id) {
                  ... on ProjectV2 {
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2SingleSelectField { id name options { id name } }
                      }
                    }
                  }
                }
              }`, { id: PROJECT_ID });
            
            const statusField = projectRes.node.fields.nodes.find(f => f.name === 'Status');
            
            // **การตรวจสอบข้อผิดพลาด 1: Field Name**
            if (!statusField) {
              core.setFailed("Error: 'Status' field not found. Check Field Name and case sensitivity in Project Settings.");
              return; 
            }
            
            const statusFieldId = statusField.id;
            const inProgressOption = statusField.options.find(o => o.name === 'In Progress');
            
            // **การตรวจสอบข้อผิดพลาด 2: Option Name**
            if (!inProgressOption) {
              core.setFailed("Error: 'In Progress' option not found in Status field. Check Option Name and case sensitivity in Project Settings.");
              return;
            }
            const inProgressOptionId = inProgressOption.id;

            // 2. ทำการ Mutation เพื่อ Update Status
            await github.graphql(`
              mutation updateProjectStatus($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId,
                  itemId: $itemId,
                  fieldId: $fieldId,
                  value: { singleSelectOptionId: $optionId }
                }) {
                  projectV2Item { id }
                }
              }`, {
              projectId: PROJECT_ID,
              itemId: CONTENT_ID,
              fieldId: statusFieldId,
              optionId: inProgressOptionId,
            });
            
            core.info(`Successfully moved item ${CONTENT_ID} to Status: In Progress`);